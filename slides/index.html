<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qu·∫£n l√Ω th∆∞ m·ª•c slides</title>
  <style>
    :root{--gap:12px}
    body{font-family:system-ui,Arial;padding:24px;max-width:1100px;margin:auto}
    h1{margin:0 0 8px}
    .muted{color:#666}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{border:1px solid #e5e5e5;border-radius:12px;padding:16px;margin:16px 0}
    button{padding:9px 14px;border:0;border-radius:10px;cursor:pointer}
    input,button{font-size:15px}
    .btn{background:#f2f2f2}
    .btn.primary{background:#111;color:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .tile{border:1px solid #ddd;border-radius:12px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:8px}
    .tile img{width:100%;height:150px;object-fit:cover;border-radius:8px;border:1px solid #eee}
    .name{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .row-actions{display:flex;gap:8px;align-items:center}
    .row-actions input[type="text"]{flex:1;min-width:0}
    .topbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .left{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{background:#f6f6f6;border:1px solid #e7e7e7;border-radius:99px;padding:6px 10px}
    .ok{color:#0a9a00}.err{color:#b00020}
    .divider{height:1px;background:#eee;margin:12px 0}
    .hint{font-size:12px;color:#666}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <h1>Qu·∫£n l√Ω th∆∞ m·ª•c <code>slides/</code></h1>
      <span id="count" class="pill muted">0 ·∫£nh</span>
    </div>
    <div class="right">
      <button id="btnRefresh" class="btn">‚Üª T·∫£i l·∫°i</button>
      <button id="btnRebuild" class="btn">üõ† Rebuild manifest</button>
      <span id="msgTop" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="files" type="file" accept="image/*" multiple />
      <button id="btnUpload" class="btn primary">‚¨ÜÔ∏è T·∫£i ·∫£nh l√™n</button>
      <span id="msgUp" class="muted"></span>
    </div>
    <div class="hint">T√™n file s·∫Ω ƒë∆∞·ª£c gi·ªØ nguy√™n (ƒë∆∞·ª£c l√†m s·∫°ch k√Ω t·ª±). N·∫øu tr√πng s·∫Ω t·ª± th√™m h·∫≠u t·ªë <code>-1</code>, <code>-2</code>‚Ä¶</div>
  </div>

  <div id="list" class="grid"></div>

<script>
  const $ = s => document.querySelector(s);
  const listEl = $('#list');
  const countEl = $('#count');
  const msgTop = $('#msgTop');
  const msgUp = $('#msgUp');

  async function api(path, opt={}) {
    const res = await fetch(path, opt);
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.error || res.statusText);
    return data;
  }

  function tileTemplate(item){
    const imgUrl = item.download_url || item.raw_url || item.url;
    const name = item.name;
    return `
      <div class="tile" data-path="${item.path}">
        <img src="${imgUrl}" alt="${name}">
        <div class="name" title="${item.path}">${name}</div>
        <div class="row-actions">
          <input type="text" class="newname" value="${name}">
          <button class="btn btn-rename">ƒê·ªïi t√™n</button>
          <button class="btn btn-del">X√≥a</button>
        </div>
      </div>
    `;
  }

  async function load() {
    msgTop.textContent = 'ƒêang t·∫£i...';
    const data = await api('/api/files');
    listEl.innerHTML = data.items.map(tileTemplate).join('');
    countEl.textContent = `${data.items.length} ·∫£nh`;
    msgTop.textContent = '';
    bindTileEvents();
  }

  function bindTileEvents(){
    document.querySelectorAll('.tile').forEach(tile => {
      const path = tile.dataset.path;
      const btnDel = tile.querySelector('.btn-del');
      const btnRename = tile.querySelector('.btn-rename');
      const input = tile.querySelector('.newname');

      btnDel.onclick = async () => {
        if (!confirm('X√≥a file n√†y kh·ªèi slides/?')) return;
        btnDel.disabled = true;
        try{
          const res = await api('/api/files', {
            method:'DELETE',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ path })
          });
          msgTop.textContent = `‚úî ƒê√£ x√≥a ${res.removed} file. Manifest c·∫≠p nh·∫≠t: ${res.manifestCount} m·ª•c`;
          msgTop.className='ok';
          await load();
        }catch(e){
          alert(e.message);
        }finally{
          btnDel.disabled = false;
        }
      };

      btnRename.onclick = async () => {
        const newName = input.value.trim();
        if (!newName || newName === path.split('/').pop()) return;
        btnRename.disabled = true;
        try{
          const res = await api('/api/files', {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ old_path: path, new_name: newName })
          });
          msgTop.textContent = `‚úî ƒê√£ ƒë·ªïi t√™n. Manifest c·∫≠p nh·∫≠t: ${res.manifestCount} m·ª•c`;
          msgTop.className='ok';
          await load();
        }catch(e){
          alert(e.message);
        }finally{
          btnRename.disabled = false;
        }
      };
    });
  }

  $('#btnUpload').onclick = async () => {
    const files = $('#files').files;
    if(!files || !files.length){ msgUp.textContent='Ch∆∞a ch·ªçn ·∫£nh'; msgUp.className='err'; return; }
    msgUp.textContent = 'ƒêang t·∫£i...'; msgUp.className='muted';
    const fd = new FormData();
    Array.from(files).forEach(f => fd.append('images', f));
    try{
      const res = await api('/api/files', { method:'POST', body: fd });
      msgUp.textContent = `‚úî ƒê√£ th√™m ${res.added} ·∫£nh (manifest: ${res.manifestCount} m·ª•c)`;
      msgUp.className='ok';
      $('#files').value='';
      await load();
    }catch(e){
      msgUp.textContent = '‚úñ ' + e.message; msgUp.className='err';
    }
  };

  $('#btnRefresh').onclick = load;

  $('#btnRebuild').onclick = async () => {
    try{
      const res = await api('/api/manifest', { method:'POST' });
      msgTop.textContent = `‚úî Rebuild manifest xong: ${res.manifestCount} m·ª•c`;
      msgTop.className='ok';
    }catch(e){
      alert(e.message);
    }
  };

  load();
</script>
</body>
</html>
